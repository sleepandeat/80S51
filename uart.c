/*-----------------------------------------------------
文件：串口通信
公司：南京爱思电子
编写：rantg
日期：2012.3
内容：打开串口调试程序，将波特率设置为9600，无奇偶校验
      晶振11.0592MHz，发送和接收使用的格式相同，在发送
	  区输入任意信，然后在发送区发送任意信息，接收区返
	  回同样信息，表明串口收发无误
-------------------------------------------------------*/

#include<reg52.h>                        

void SendStr(unsigned char *s);

/*------------------------------------------------
                    串口初始化
------------------------------------------------*/
void InitUART  (void)
{
	SCON = 0x50;		        // SCON: 模式 1, 8-bit UART, 使能接收  
	TMOD |= 0x20;               // TMOD: timer 1, mode 2, 8-bit 重装
	TH1 = 0xFD;               // TH1:  重装值 9600 波特率 晶振 11.0592MHz  
	TR1 = 1;                  // TR1:  timer 1 打开                         
	EA = 1;                  //打开总中断
}   
                   
/*------------------------------------------------
                    主函数
------------------------------------------------*/
void main (void)
{
	InitUART();
	SendStr("51单片机开发板串口测试程序\r\n\t南京爱思电子\r\n");
	ES = 1;                 
	while (1)                       
    {
    }
}

/*------------------------------------------------
                    发送一个字节
------------------------------------------------*/
void SendByte(unsigned char dat)
{
	SBUF = dat;
	while(!TI);
		TI = 0;
}

/*------------------------------------------------
                    发送一个字符串
------------------------------------------------*/
void SendStr(unsigned char *s)
{
	while(*s != '\0')	
	{
		SendByte(*s);
		s++;
	}
}

/*------------------------------------------------
                     串口中断程序
------------------------------------------------*/
void UART_SER (void) interrupt 4 //串行中断服务程序
{
	unsigned char Temp;          //定义临时变量 
	
	if(RI)                        //判断是接收中断产生
	{
		RI = 0;                      //标志位清零
		Temp = SBUF;                 //读入缓冲区的值
		P2 = Temp;                   //把值输出到P2口，用于观察
		SBUF = Temp;                 //把接收到的值再发回电脑端
	}
	if(TI)                        //如果是发送标志位，清零
		TI = 0;
} 

